// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User Model - نموذج المستخدم
model User {
  id            String    @id @default(cuid())
  firstName     String    @map("first_name")
  lastName      String    @map("last_name")
  email         String?   @unique
  phone         String?   @unique
  password      String
  role          Role      @default(USER)
  image         String?   @default("/images/default-avatar.svg")
  emailVerified DateTime? @map("email_verified")
  phoneVerified DateTime? @map("phone_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // العلاقات
  feasibilityStudies FeasibilityStudy[] @relation("AdminStudies")

  @@map("users")
}

// Role Enum - أدوار المستخدمين
enum Role {
  USER  // مستخدم عادي
  ADMIN // مدير
}

// Consultation Status - حالات طلب الاستشارة
enum ConsultationStatus {
  PENDING   // جديد - في انتظار المراجعة
  ACCEPTED  // مقبول (قيمة قديمة - محفوظة للتوافق)
  REJECTED  // مرفوض (قيمة قديمة - محفوظة للتوافق)
  READ      // تم القراءة
  COMPLETED // مكتمل
}

// Feasibility Study Status - حالات دراسة الجدوى
enum StudyStatus {
  DRAFT     // مسودة
  SENT      // تم الإرسال
  VIEWED    // تمت المشاهدة
}

// نوع العقار - Property Type
enum PropertyType {
  APARTMENT     // شقة
  VILLA         // فيلا
  STUDIO        // استوديو
  DUPLEX        // دوبلكس
  PENTHOUSE     // بنتهاوس
  CHALET        // شاليه
  OTHER         // أخرى
}

// نوع دراسة الجدوى - Study Request Type
enum StudyRequestType {
  WITHOUT_FIELD_VISIT   // بدون نزول ميداني
  WITH_FIELD_VISIT      // مع نزول ميداني
}

// حالة طلب دراسة الجدوى - Feasibility Request Status
enum FeasibilityRequestStatus {
  PENDING       // في الانتظار
  IN_PROGRESS   // قيد المعالجة
  COMPLETED     // مكتمل
  REJECTED      // مرفوض
}

// Consultation Model - نموذج طلب الاستشارة
model Consultation {
  id          String             @id @default(cuid())
  firstName   String             @map("first_name")
  lastName    String             @map("last_name")
  email       String
  phone       String?
  message     String
  
  // تكوين الشقة (اختياري)
  bedrooms    Int?               @default(0)
  livingRooms Int?               @default(0) @map("living_rooms")
  kitchens    Int?               @default(0)
  bathrooms   Int?               @default(0)
  
  status      ConsultationStatus @default(PENDING)
  
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")

  @@map("consultations")
}

// Feasibility Study Model - نموذج دراسة الجدوى
model FeasibilityStudy {
  id          String      @id @default(cuid())
  title       String
  clientName  String      @map("client_name")
  clientEmail String?     @map("client_email")
  clientPhone String?     @map("client_phone")
  
  // نوع الدراسة
  studyType   StudyRequestType  @default(WITH_FIELD_VISIT) @map("study_type")
  
  // بيانات الشرائح (JSON)
  slides      Json
  
  // تكوين الغرف
  bedrooms    Int         @default(1)
  livingRooms Int         @default(1) @map("living_rooms")
  kitchens    Int         @default(0)
  bathrooms   Int         @default(1)
  
  // التكلفة الإجمالية
  totalCost   Float       @default(0) @map("total_cost")
  
  // العملة المستخدمة
  currency    String      @default("EGP")
  
  // الحالة
  status      StudyStatus @default(DRAFT)
  
  // رابط المشاركة
  shareId     String?     @unique @map("share_id")
  
  // الأدمن المسؤول
  admin       User        @relation("AdminStudies", fields: [adminId], references: [id])
  adminId     String      @map("admin_id")
  
  // طلب دراسة الجدوى المرتبط (اختياري)
  feasibilityRequest   FeasibilityRequest? @relation("RequestStudy", fields: [feasibilityRequestId], references: [id])
  feasibilityRequestId String?             @unique @map("feasibility_request_id")
  
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  sentAt      DateTime?   @map("sent_at")
  viewedAt    DateTime?   @map("viewed_at")

  @@map("feasibility_studies")
}

// Feasibility Request Model - نموذج طلب دراسة الجدوى (النظام الجديد)
model FeasibilityRequest {
  id              String                    @id @default(cuid())
  
  // نوع الدراسة
  studyType       StudyRequestType          @map("study_type")
  
  // بيانات العميل
  fullName        String                    @map("full_name")
  phone           String                    // رقم الهاتف للتحقق (مطلوب)
  phoneVerified   Boolean                   @default(false) @map("phone_verified")
  
  // بيانات العقار
  propertyType    PropertyType              @map("property_type")
  bedrooms        Int                       @default(1)
  livingRooms     Int                       @default(1) @map("living_rooms")
  kitchens        Int                       @default(0)
  bathrooms       Int                       @default(1)
  
  // بيانات الموقع
  city            String
  district        String
  googleMapsUrl   String?                   @map("google_maps_url")
  latitude        Float?
  longitude       Float?
  
  // الحالة
  status          FeasibilityRequestStatus  @default(PENDING)
  
  // رمز الدفع - يتم إنشاؤه تلقائياً لكل طلب
  paymentCode     String                    @unique @map("payment_code")
  
  // ملاحظات الأدمن
  adminNotes      String?                   @map("admin_notes")
  
  // العلاقة مع دراسة الجدوى (عند إنشائها)
  feasibilityStudy FeasibilityStudy?        @relation("RequestStudy")
  
  createdAt       DateTime                  @default(now()) @map("created_at")
  updatedAt       DateTime                  @updatedAt @map("updated_at")

  @@map("feasibility_requests")
}

// Email Verification Model - نموذج التحقق من البريد الإلكتروني (Legacy)
model EmailVerification {
  id          String    @id @default(cuid())
  email       String
  code        String
  expiresAt   DateTime  @map("expires_at")
  verified    Boolean   @default(false)
  verifiedAt  DateTime? @map("verified_at")
  attempts    Int       @default(0)
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([email, code])
  @@index([email, expiresAt])
  @@map("email_verifications")
}

// Phone Verification Model - نموذج التحقق من رقم الهاتف
model PhoneVerification {
  id              String    @id @default(cuid())
  phoneNumber     String    @map("phone_number")
  firebaseUid     String?   @map("firebase_uid")     // Firebase user ID after verification
  verified        Boolean   @default(false)
  verifiedAt      DateTime? @map("verified_at")
  expiresAt       DateTime  @map("expires_at")       // Verification validity (24 hours)
  createdAt       DateTime  @default(now()) @map("created_at")

  @@unique([phoneNumber, verified])                   // Only one verified record per phone
  @@index([phoneNumber, expiresAt])
  @@index([phoneNumber, verified])
  @@map("phone_verifications")
}

// Library Item Customization - تخصيصات عناصر المكتبة (الأسعار والصور والأوصاف)
model LibraryItemCustomization {
  id           String   @id @default(cuid())
  
  // معرف العنصر في المكتبة (مثل: fridge, double-bed, toilet)
  itemId       String   @unique @map("item_id")
  
  // نوع الغرفة (bedroom, kitchen, bathroom, living-room)
  roomType     String   @map("room_type")
  
  // السعر المخصص (آخر سعر تم إدخاله)
  customPrice  Float?   @map("custom_price")
  
  // صورة العنصر (Base64 أو رابط Vercel Blob)
  image        String?  @db.Text
  
  // وصف العنصر المخصص
  description  String?  @db.Text
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([roomType])
  @@map("library_item_customizations")
}

// Password Reset Model - نموذج إعادة تعيين كلمة المرور
model PasswordReset {
  id          String    @id @default(cuid())
  email       String?
  phone       String?
  code        String                               // 6-digit OTP code
  expiresAt   DateTime  @map("expires_at")         // 10 minutes validity
  used        Boolean   @default(false)
  usedAt      DateTime? @map("used_at")
  attempts    Int       @default(0)                // Failed verification attempts
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([email, code])
  @@index([phone, code])
  @@index([email, expiresAt])
  @@index([phone, expiresAt])
  @@map("password_resets")
}
